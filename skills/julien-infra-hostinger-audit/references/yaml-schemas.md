# YAML Schemas for Audit Output Files

Complete schemas for all inventory and report files generated by the audit skill.

## containers.yml

```yaml
# Docker Containers Inventory
metadata:
  generated_at: "2025-12-09T17:00:00Z"  # ISO-8601 format
  server: srv759970.hstgr.cloud
  total_containers: 50
  running: 49
  stopped: 1
  unhealthy: 6

containers:
  - name: "container-name"           # Container name
    image: "image:tag"               # Full image reference
    status: "running"                # running|exited|restarting|paused
    health: "healthy"                # healthy|unhealthy|starting|none
    ports:
      - "8080:80"                    # Host:Container port mappings
      - "443:443"
    created: "2025-12-01T10:00:00Z"  # Creation timestamp
    uptime: "Up 3 days"              # Human-readable uptime
    size: "150MB"                    # Container size
    compose_dir: "/opt/project/"     # Docker compose location
    registry_match: true             # Found in registry.yml
    registry_name: "project-name"    # Name in registry (if different)
    category: "ai_services"          # Category from registry
    recommendation: null             # Action if needed

# Groupings
by_status:
  running: ["container1", "container2"]
  exited: ["container3"]
  restarting: ["container4"]
  unhealthy: ["container5", "container6"]

by_registry:
  documented: ["container1", "container2"]
  undocumented: ["container3", "container4"]
```

## images.yml

```yaml
# Docker Images Inventory
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  total_images: 45
  total_size: "33.15GB"
  dangling_count: 2
  reclaimable: "9.365GB"

images:
  - repository: "nginx"              # Image repository
    tag: "alpine"                    # Image tag
    id: "abc123def456"               # Short image ID
    size: "52.8MB"                   # Image size
    created: "2025-11-15"            # Creation date
    in_use: true                     # Used by container(s)
    containers:                      # List of containers using this image
      - "nginx-main"
      - "nginx-test"
    dangling: false                  # Is <none>:<none>
    recommendation: "KEEP"           # KEEP|DELETE|TAG|REVIEW

# Dangling images (special attention)
dangling_images:
  - id: "d39037f5b4df"
    size: "6.65GB"
    in_use: true
    containers: ["paperflow-api", "paperflow-worker"]
    safe_to_delete: false
    action: "docker tag d39037f5b4df paperflow:latest"

summary:
  by_usage:
    in_use: 43
    unused: 2
  by_size:
    large_1gb_plus: 6
    medium_100mb_1gb: 30
    small_under_100mb: 9
```

## scripts.yml

```yaml
# Scripts Inventory
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  total_scripts: 150
  locations_scanned:
    - /opt/scripts
    - /usr/local/bin
    - /root/scripts
    - /root
    - /home/automation/scripts
    - /opt/*/scripts

# Scripts by location
opt_scripts:
  location: "/opt/scripts/"
  count: 12
  status: "primary"                  # primary|secondary|wrong_location
  scripts:
    - name: "backup-wordpress.sh"
      purpose: "Daily WordPress backup"
      cron: "0 3 * * *"              # Cron schedule or null
      cron_user: "root"              # Which user's crontab
      systemd: null                  # Systemd service/timer or null
      documented: true
      last_modified: "2025-12-01"
      recommendation: null

root_scripts:
  location: "/root/scripts/"
  count: 5
  status: "wrong_location"
  warning: "Scripts should be in /opt/scripts/"
  scripts:
    - name: "backup-configs.sh"
      purpose: "Backup configurations"
      duplicate_of: "/opt/scripts/backup-configs.sh"
      recommendation: "DELETE - duplicate exists"

application_scripts:
  - location: "/opt/audioguides/"
    count: 20
    purpose: "Audio guide generation"
    documented: false
    scripts:
      - "gen.sh"
      - "gen-aubagne.sh"
      - "generate-audio.py"
    recommendation: "Document in project"

# Issues
issues:
  duplicates:
    - script: "backup-configs.sh"
      locations:
        - "/root/scripts/"
        - "/opt/scripts/"
      recommendation: "Keep /opt/scripts/ version"

  wrong_location:
    - script: "/root/service-manager.sh"
      should_be: "/opt/scripts/"
    - script: "/root/install-wpcli.sh"
      should_be: "/opt/scripts/archived/"
```

## systemd.yml

```yaml
# Systemd Services & Timers Inventory
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  custom_services: 15
  custom_timers: 6
  pm2_processes: 3

# Custom systemd services (non-standard)
custom_services:
  - name: "docker-autostart.service"
    description: "Docker container auto-start"
    status: "running"                # running|stopped|failed
    enabled: true                    # Starts on boot
    type: "simple"                   # simple|forking|oneshot
    location: "/opt/docker-autostart/"
    exec_start: "/usr/bin/node server.js"
    port: null
    documented: true
    category: "infrastructure"
    recommendation: null

  - name: "mcp-nodejs.service"
    description: "MCP Server Node.js"
    status: "running"
    enabled: true
    location: "/var/www/mcp-servers/"
    port: 3100
    documented: false
    category: "ai_services"
    recommendation: "ADD to registry.yml"

# Systemd timers
timers:
  - name: "certbot.timer"
    description: "SSL certificate renewal"
    schedule: "0 */12 * * *"         # Cron-style or OnCalendar
    service: "certbot.service"
    documented: true
    category: "security"

  - name: "ollama-idle-stop.timer"
    description: "Stop Ollama when idle"
    schedule: "*/5 * * * *"
    service: "ollama-idle-stop.service"
    script: "/root/scripts/ollama-idle-stop.sh"
    documented: false
    recommendation: "Move script to /opt/scripts/"

# PM2 processes
pm2_processes:
  user: "automation"
  processes:
    - name: "incluzhact"
      script: "/var/www/incluzhact/server.js"
      status: "online"               # online|stopped|errored
      mode: "fork"                   # fork|cluster
      port: 3050
      memory: "150MB"
      uptime: "3d 5h"
      documented: false
      recommendation: "ADD to registry.yml"

# Summary
summary:
  undocumented:
    services: 5
    timers: 3
    pm2: 2
```

## cron.yml

```yaml
# Cron Jobs Inventory
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  total_jobs: 12
  users_with_cron: ["root", "automation"]

# Root crontab
root_crontab:
  user: "root"
  source: "crontab -l"
  jobs:
    - schedule: "0 3 * * *"
      command: "/opt/scripts/backup-wordpress.sh"
      purpose: "Daily WordPress backup"
      documented: false
      critical: true

# Automation user crontab
automation_crontab:
  user: "automation"
  source: "crontab -l"
  jobs:
    - schedule: "0 3 * * *"
      command: "/opt/scripts/backup-wordpress.sh"
      purpose: "Daily WordPress backup"
      duplicate_of: "root crontab"   # Flag duplicates
      recommendation: "CONSOLIDATE"

# System crontab
system_crontab:
  location: "/etc/crontab"
  jobs:
    - schedule: "17 * * * *"
      user: "root"
      command: "cd / && run-parts --report /etc/cron.hourly"
      system: true

# /etc/cron.d/ files
cron_d:
  location: "/etc/cron.d/"
  files:
    - name: "certbot"
      purpose: "SSL renewal"
      schedule: "0 */12 * * *"
      documented: true

# Issues
issues:
  duplicates:
    - job: "backup-wordpress.sh"
      locations: ["root", "automation"]
      recommendation: "Keep only one"

  high_frequency:
    - job: "check-dropbox-mount.sh"
      schedule: "* * * * *"
      recommendation: "Reduce to */5 * * * *"

# Backup schedule overview
backup_schedule:
  daily_3am:
    - "backup-wordpress.sh"
    - "backup-to-dropbox.sh"
  monthly_1st:
    - "backup-infrastructure.sh"
```

## portals.yml

```yaml
# Portals & Dashboards Inventory
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  total_portals: 13
  documented: 2
  undocumented: 11

portals:
  - name: "api-portal"
    type: "admin"                    # admin|dashboard|monitoring|app
    location: "/opt/api-portal/"
    url: "https://portal.srv759970.hstgr.cloud"
    nginx_config: "/etc/nginx/sites-enabled/portal"
    container: null                  # null if static/native
    status: "active"
    auth: "basic-auth"
    ssl: "valid"
    ssl_expiry: "2026-02-15"
    documented: false
    in_registry: false
    features:
      - "Swagger UI"
      - "Portainer link"
      - "Monitoring links"
    recommendation: "ADD to registry.yml"

  - name: "grafana"
    type: "monitoring"
    location: "/opt/monitoring/grafana/"
    url: "https://monitoring.srv759970.hstgr.cloud"
    container: "grafana"
    port: 3000
    status: "running"
    documented: true
    in_registry: true

monitoring_dashboards:
  - name: "doku"
    purpose: "Docker disk usage"
    url: "https://doku.srv759970.hstgr.cloud"
    container: "doku"
    port: 9091
    documented: false

application_dashboards:
  - name: "downto40-streamlit"
    purpose: "Energy consumption"
    url: "https://energie.srv759970.hstgr.cloud"
    framework: "Streamlit"
    container: "downto40-streamlit"
    documented: false

# Undocumented /opt/ directories
undocumented_directories:
  - path: "/opt/invidious/"
    status: "removed"
    recommendation: "DELETE directory"
  - path: "/opt/collaboration-stack/"
    status: "empty"
    recommendation: "DELETE if unused"
```

## orphans-report.yml

```yaml
# Orphan Resources Report
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  total_issues: 42
  reclaimable_space: "~12GB"

# Dangling images
dangling_images:
  count: 2
  total_size: "6.93GB"
  items:
    - id: "d39037f5b4df"
      size: "6.65GB"
      in_use: true
      containers: ["paperflow-api"]
      safe_to_delete: false
      action: "docker tag d39037f5b4df paperflow:latest"

# Orphan volumes
orphan_volumes:
  count: 35
  estimated_size: "~4-8GB"
  safe_to_delete:
    - "invidious_invidious-db-data"
    - "open-webui"
  needs_review:
    - name: "whisperx_whisperx-models"
      reason: "ML models, high value"

# Unhealthy containers
unhealthy_containers:
  count: 6
  items:
    - name: "discord-voice-bot"
      status: "unhealthy"
      uptime: "Up 3 days"
      recommendation: "Check logs"

# Restarting containers
restarting_containers:
  count: 1
  items:
    - name: "rq-exporter-whisperx"
      status: "Restarting (1)"
      recommendation: "Investigate and fix"

# Cleanup commands
cleanup_commands:
  safe:
    description: "Zero-risk cleanup"
    commands:
      - "docker volume rm invidious_invidious-db-data"
      - "docker volume rm open-webui"
    estimated_gain: "~500MB-1GB"

  tag_dangling:
    description: "Tag images in use"
    commands:
      - "docker tag d39037f5b4df paperflow:latest"
```

## registry-diff.yml

```yaml
# Registry vs Actual State Diff
metadata:
  generated_at: "2025-12-09T17:00:00Z"
  server: srv759970.hstgr.cloud
  registry_path: "docs/applications/registry.yml"
  registry_apps: 45
  actual_containers: 50

summary:
  containers:
    in_sync: 25
    in_registry_only: 20
    on_server_only: 25
  nginx:
    with_backend: 55
    orphan_configs: 12
  ssl:
    valid: 60
    expiring_soon: 8

# On server but not in registry
on_server_not_in_registry:
  media_stack:
    - container: "jellyfin"
      image: "jellyfin/jellyfin:latest"
      ports: ["8096"]
      nginx_site: "jellyfin.srv759970.hstgr.cloud"
      ssl: "valid (84 days)"
      action: "ADD to registry"

# In registry but not running
in_registry_not_running:
  - name: "whisperx"
    registry_status: "production"
    nginx_site: "whisperx.srv759970.hstgr.cloud"
    note: "Auto-start service, may be sleeping"

# Nginx orphan sites
nginx_orphan_sites:
  count: 12
  items:
    - site: "memvid"
      expected_backend: "memvid:8020"
      status: "Backend stopped"

# SSL expiring soon
ssl_expiring_soon:
  count: 8
  items:
    - domain: "sharepoint.srv759970.hstgr.cloud"
      expiry: "2026-01-08"
      days_left: 29

# Recommendations
recommendations:
  high_priority:
    - "Add 11 media stack services to registry"
    - "Fix 6 unhealthy containers"
  medium_priority:
    - "Renew 8 SSL certificates"
  low_priority:
    - "Review 3 test containers"
```

## audit-report.md Structure

```markdown
# Infrastructure Audit Report

**Server**: srv759970.hstgr.cloud
**Date**: 2025-12-09 17:00:00
**Type**: Full Audit

## Executive Summary

| Metric | Count | Status |
|--------|-------|--------|
| Total Containers | 50 | ... |

### Health Score: XX/100

## Critical Issues (N)
### 1. Issue title
...

## [Category] Section
...

## Recommended Actions
### Immediate
### This Week
### This Month

## Files Generated
| File | Description |
...
```
