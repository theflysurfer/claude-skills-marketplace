# ========================================
# Rate Limiting Zones - Nginx
# ========================================
# À inclure dans le block http{} de nginx.conf
#
# Usage:
# include /etc/nginx/conf.d/rate-limiting.conf;

# ========================================
# WordPress Rate Limiting Zones
# ========================================

# XML-RPC Protection (1 request per second)
# Empêche les attaques DDoS via pingbacks
limit_req_zone $binary_remote_addr zone=xmlrpc:10m rate=1r/s;

# wp-login.php Protection (10 requests per minute)
# Empêche les attaques brute force
limit_req_zone $binary_remote_addr zone=wplogin:10m rate=10r/m;

# REST API Protection (10 requests per second)
# Empêche l'abus de l'API WordPress
limit_req_zone $binary_remote_addr zone=wpapi:10m rate=10r/s;

# Admin Area Protection (20 requests per second)
# Protection générale pour /wp-admin/
limit_req_zone $binary_remote_addr zone=wpadmin:10m rate=20r/s;

# ========================================
# General Rate Limiting Zones
# ========================================

# General site protection (100 requests per second)
# Protection contre flood général
limit_req_zone $binary_remote_addr zone=general:10m rate=100r/s;

# API endpoints protection (30 requests per second)
# Pour autres APIs que WordPress
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# Search/Form protection (5 requests per minute)
# Pour les formulaires de recherche/contact
limit_req_zone $binary_remote_addr zone=search:10m rate=5r/m;

# ========================================
# Connection Limiting
# ========================================

# Limite le nombre de connexions simultanées par IP
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ========================================
# Notes d'Utilisation
# ========================================
#
# Dans les server blocks, utiliser:
#
# location = /xmlrpc.php {
#     limit_req zone=xmlrpc burst=5 nodelay;
#     ...
# }
#
# location = /wp-login.php {
#     limit_req zone=wplogin burst=5 nodelay;
#     ...
# }
#
# location ~ ^/wp-json/ {
#     limit_req zone=wpapi burst=20 nodelay;
#     ...
# }
#
# Paramètres:
# - burst: Nombre de requêtes autorisées en burst avant reject
# - nodelay: Traite immédiatement les requêtes dans le burst
#
# Sans nodelay, les requêtes sont mises en queue.
#
# Codes retour:
# - 503 Service Temporarily Unavailable = Rate limit exceeded
#
# ========================================
# Monitoring
# ========================================
#
# Voir les rate limits en action:
# tail -f /var/log/nginx/error.log | grep "limiting requests"
#
# Exemple output:
# 2025/10/28 10:15:30 [error] limiting requests, excess: 5.123 by zone "wplogin", client: 1.2.3.4
#
