# ========================================
# Nginx WordPress Configuration Template
# ========================================
# Template for WordPress sites behind reverse proxy (Docker)
#
# BEFORE USING THIS TEMPLATE:
# 1. Replace all {{PLACEHOLDERS}} with actual values
# 2. Run validation: ./scripts/validate-nginx-config.sh {{SITE_NAME}}
# 3. Deploy: ./scripts/nginx-deploy.sh configs/sites-available/{{SITE_NAME}} {{SITE_NAME}}

# ============================================
# HTTPS - WordPress Site
# ============================================
server {
    # CRITICAL: Always include both IPv4 and IPv6 listen directives
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Site domain name
    server_name {{DOMAIN_NAME}};

    # SSL Certificate (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/{{DOMAIN_NAME}}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{DOMAIN_NAME}}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Logging
    access_log /var/log/nginx/{{SITE_NAME}}-access.log;
    error_log /var/log/nginx/{{SITE_NAME}}-error.log;

    # Security Headers (WordPress-compatible CSP)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https:; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

    # Upload size (WordPress media)
    client_max_body_size 100M;

    # Optional: Basic Authentication (uncomment if dev site)
    # include snippets/basic-auth.conf;

    # WordPress-compatible bot protection (allows wp-admin)
    include snippets/bot-protection-wordpress.conf;

    # HTTP Method Restriction (security best practice)
    include snippets/http-method-restriction.conf;

    # Block PHP execution in uploads (prevent backdoor)
    location ~* /(?:uploads|files|wp-content/uploads)/.*\.php$ {
        deny all;
        return 403;
    }

    # Rate Limiting: wp-login.php (brute force protection)
    location = /wp-login.php {
        limit_req zone=wplogin burst=5 nodelay;
        limit_req_status 429;

        # CRITICAL: Replace with your WordPress backend port
        proxy_pass http://127.0.0.1:{{BACKEND_PORT}};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        client_max_body_size 100M;
    }

    # Rate Limiting: XML-RPC (DDoS protection)
    # Note: Already blocked by bot-protection-wordpress.conf
    # But adding rate limit as defense in depth
    location = /xmlrpc.php {
        limit_req zone=xmlrpc burst=2 nodelay;
        limit_req_status 429;

        # Block completely (pingback DDoS)
        return 444;
    }

    # Rate Limiting: REST API
    location ~ ^/wp-json/ {
        limit_req zone=wpapi burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:{{BACKEND_PORT}};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Rate Limiting: wp-admin area
    location ~ ^/wp-admin/ {
        limit_req zone=wpadmin burst=50 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:{{BACKEND_PORT}};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        client_max_body_size 100M;
    }

    # Default location - All other requests
    location / {
        # CRITICAL: Replace with your WordPress backend port
        proxy_pass http://127.0.0.1:{{BACKEND_PORT}};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        client_max_body_size 100M;
    }
}

# ============================================
# HTTP → HTTPS Redirect
# ============================================
server {
    # CRITICAL: Include both IPv4 and IPv6
    listen 80;
    listen [::]:80;

    server_name {{DOMAIN_NAME}};

    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# ========================================
# DEPLOYMENT CHECKLIST
# ========================================
#
# Before deploying this config:
#
# ✅ 1. Replace all {{PLACEHOLDERS}}:
#       - {{DOMAIN_NAME}}: e.g., mywordpress.srv759970.hstgr.cloud
#       - {{SITE_NAME}}: e.g., mywordpress (for logs)
#       - {{BACKEND_PORT}}: e.g., 9002 (WordPress container port)
#
# ✅ 2. Verify SSL certificate exists:
#       ssh automation@69.62.108.82 "ls -lh /etc/letsencrypt/live/{{DOMAIN_NAME}}"
#
# ✅ 3. Verify rate limiting zones are configured:
#       ssh automation@69.62.108.82 "sudo nginx -T | grep 'limit_req_zone'"
#       Should show: wplogin, xmlrpc, wpapi, wpadmin
#
# ✅ 4. Test WordPress backend is running:
#       ssh automation@69.62.108.82 "curl -I http://localhost:{{BACKEND_PORT}}"
#
# ✅ 5. Verify snippets exist:
#       - /etc/nginx/snippets/bot-protection-wordpress.conf
#       - /etc/nginx/snippets/http-method-restriction.conf
#
# ✅ 6. Validate configuration:
#       ./scripts/validate-nginx-config.sh {{SITE_NAME}}
#
# ✅ 7. Deploy safely:
#       ./scripts/nginx-deploy.sh configs/sites-available/{{SITE_NAME}} {{SITE_NAME}}
#
# ✅ 8. Test access:
#       curl -k -I https://{{DOMAIN_NAME}}/
#       curl -k -I https://{{DOMAIN_NAME}}/wp-admin/
#       (Should return HTTP 200 and HTTP 302 respectively)
#
# ========================================
# COMMON WORDPRESS ISSUES & SOLUTIONS
# ========================================
#
# Issue: wp-admin returns 404
# Cause: Bot protection blocking wp-admin
# Fix:   Use bot-protection-wordpress.conf (NOT bot-protection.conf)
#
# Issue: Too many redirects
# Cause: Missing X-Forwarded-Proto header
# Fix:   Ensure all proxy locations have proxy_set_header X-Forwarded-Proto $scheme
#
# Issue: Media upload fails
# Cause: client_max_body_size too small
# Fix:   Ensure client_max_body_size 100M in wp-admin and wp-login locations
#
# Issue: Brute force attacks not blocked
# Cause: Rate limiting not working
# Fix:   Verify rate limiting zones exist in /etc/nginx/conf.d/rate-limiting-zones.conf
#
# Issue: XML-RPC DDoS
# Cause: xmlrpc.php not blocked
# Fix:   Verify bot-protection-wordpress.conf includes xmlrpc block
#
# Issue: PHP backdoor in uploads
# Cause: PHP execution not blocked
# Fix:   Ensure block exists: location ~* /(?:uploads|files|wp-content/uploads)/.*\.php$
#
# ========================================
# FAIL2BAN INTEGRATION
# ========================================
#
# This config works with Fail2ban WordPress jails:
# - wordpress-auth: Bans after 5 failed wp-login attempts
# - wordpress-hard: Bans after 3 critical attacks (config access, etc.)
# - wordpress-xmlrpc: Bans after 2 xmlrpc abuses
#
# Verify Fail2ban is monitoring this site:
#   ssh automation@69.62.108.82 "sudo fail2ban-client status wordpress-auth"
#
# Logs are in:
#   /var/log/nginx/{{SITE_NAME}}-access.log
#   /var/log/nginx/{{SITE_NAME}}-error.log
#
# ========================================
